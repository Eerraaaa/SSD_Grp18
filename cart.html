<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Shopping Cart - ElectraEdge</title>
    <link rel="stylesheet" href="website.css" />
    <!-- Load PayPal SDK with Sandbox Client ID -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AVyilJ6eWAp302gUQQDI6HVO19xtLy7OGAp7ZUDRwmKY__jhoV6M-Xvdb3-raWXW2uX7wLtLtEbj-nh4&currency=SGD"></script>
</head>

<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <script src="js/header.js"></script>

    <section class="container" style="max-width: 600px; margin: 2rem auto; padding: 2rem; text-align: center;">
        <h1>Your Shopping Cart</h1>

        <!-- Cart items rendering -->
        <div id="cart-summary" style="margin: 2rem 0;">
            <!-- Example: Cart total -->
            <p>Total: <strong id="total-amount">$0.00</strong></p>
        </div>

        <!-- PayPal button container -->
        <div id="paypal-button-container" style="max-width: 400px; margin: 2rem auto;"></div>
    </section>

    <!-- PayPal button container -->
    <div id="paypal-button-container"></div>

    <script>
        let total = 0;
        let cartIds = JSON.parse(localStorage.getItem('cart')) || [];

        fetch('get_products.php')
            .then(r => r.json())
            .then(products => {
                const c = document.getElementById('cart-summary');
                const cartItems = products.filter(p => cartIds.includes(p.product_id));

                if (cartItems.length === 0) {
                    c.innerHTML = '<p>Your cart is empty.</p>';
                    return;
                }

                cartItems.forEach(p => {
                    c.innerHTML += `
                <div>
                  <img src="${p.image_path}" width="100">
                  <h3>${p.name}</h3>
                  <p>${p.description}</p>
                  <p>Price: $${p.price}</p>
                </div>`;
                    total += parseFloat(p.price);
                });

                document.getElementById('total-amount').innerText = `$${total.toFixed(2)}`;
            });


        paypal.Buttons({
            createOrder: (data, actions) => {
                const amount = document.getElementById('total-amount').innerText.replace('$', '');
                return fetch('php/create-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount }) // passes cart total
                })
                    .then(res => res.json())
                    .then(data => data.id);
            },
            onApprove: (data, actions) => {
                return fetch('php/capture-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderID: data.orderID })
                })
                    .then(res => res.json())
                    .then(details => {
                        alert(`Payment complete! Thank you, ${details.payer.name.given_name}.`);
                        localStorage.removeItem('cart'); // clear cart
                        window.location.href = 'order_cfm.php'; // redirect on success
                    });
            },
            onCancel: () => alert('Payment cancelled.'),
            onError: err => {
                console.error(err);
                alert('An error occurred during checkout.');
            }
        }).render('#paypal-button-container');
    </script>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <script>
        fetch("footer.html")
            .then(res => res.text())
            .then(data => {
                document.getElementById("footer-placeholder").innerHTML = data;
            });
    </script>

    <!-- Include cart JavaScript for session management -->
    <script src="js/cart.js"></script>

</body>

</html>