<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Shopping Cart - ElectraEdge</title>
    <link rel="stylesheet" href="website.css" />
    <!-- Load PayPal SDK with Sandbox Client ID -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_SANDBOX_CLIENT_ID&currency=USGD"></script>
</head>

<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <script>
        fetch('header.html')
            .then(res => res.text())
            .then(data => {
                document.getElementById('header-placeholder').innerHTML = data;
            });
    </script>

    <h1>Your Shopping Cart</h1>
    <!-- Cart items rendering -->
    <div id="cart-summary">
        <!-- Example: Cart total -->
        <p>Total: <strong id="total-amount">$0.00</strong></p>
    </div>

    <!-- PayPal button container -->
    <div id="paypal-button-container"></div>

    <script>
        let total = 0;
        fetch('get_products.php')
            .then(r => r.json())
            .then(products => {
                const c = document.getElementById('cart-summary');
                products.forEach(p => {
                    c.innerHTML += `
            <div>
              <img src="${p.image_path}" width="100">
              <h3>${p.name}</h3>
              <p>${p.description}</p>
              <p>Price: $${p.price}</p>
            </div>`;
                    total += parseFloat(p.price);
                });
                document.getElementById('total-amount').innerText = `$${total.toFixed(2)}`;
            });
            
        paypal.Buttons({
            createOrder: (data, actions) => {
                const amount = document.getElementById('total-amount').innerText.replace('$', '');
                return fetch('php/create-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount }) // passes cart total
                })
                    .then(res => res.json())
                    .then(data => data.id);
            },
            onApprove: (data, actions) => {
                return fetch('php/capture-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderID: data.orderID })
                })
                    .then(res => res.json())
                    .then(details => {
                        alert(`Payment complete! Thank you, ${details.payer.name.given_name}.`);
                        window.location.href = 'order_cfm.php'; // redirect on success
                    });
            },
            onCancel: () => alert('Payment cancelled.'),
            onError: err => {
                console.error(err);
                alert('An error occurred during checkout.');
            }
        }).render('#paypal-button-container');
    </script>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <script>
        fetch("footer.html")
            .then(res => res.text())
            .then(data => {
                document.getElementById("footer-placeholder").innerHTML = data;
            });
    </script>

    <!-- Include cart JavaScript for session management -->
    <script src="js/cart.js"></script>

</body>

</html>