<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectraEdge - Premium Electronics Shop</title>
    <link rel="stylesheet" href="website.css">
    <script src="js/session_manager.js"></script>
</head>

<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <script src="js/header.js"></script>
    

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Power Your World with ElectraEdge</h1>
            <p>Discover premium electronics with cutting-edge technology and unbeatable prices</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <a href="catalog.html" class="btn btn-primary btn-large">Shop Now</a>
                <a href="register.html" class="btn btn-secondary btn-large" id="join-electraedge-btn">Join ElectraEdge</a>
            </div>
        </div>
    </section>

    <!-- Featured Products Section -->
    <section style="padding: 4rem 0; background: white;">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 3rem; font-size: 2.5rem; color: #333;">Featured Products</h2>

            <!-- Loading state -->
            <div id="featured-loading" style="text-align: center; padding: 3rem;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2c5aa0; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
                <p style="color: #666;">Loading featured products...</p>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>

            <!-- Featured Products Grid -->
            <div class="product-grid" id="featuredProducts" style="display: none;">
                <!-- Featured products will be loaded here dynamically -->
            </div>

            <!-- Error state -->
            <div id="featured-error" style="display: none; text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem; color: #dc3545;">‚ö†Ô∏è</div>
                <h3 style="color: #dc3545; margin-bottom: 1rem;">Unable to Load Products</h3>
                <p style="color: #666; margin-bottom: 2rem;">We're having trouble loading our featured products. Please try again later.</p>
                <button onclick="loadFeaturedProducts()" style="background: #2c5aa0; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    Try Again
                </button>
            </div>

            <!-- View All Products Link -->
            <div style="text-align: center; margin-top: 3rem;">
                <a href="catalog.html" style="display: inline-block; background: #f8f9fa; color: #2c5aa0; padding: 1rem 2rem; text-decoration: none; border-radius: 8px; font-weight: bold; border: 2px solid #2c5aa0; transition: all 0.2s ease;" onmouseover="this.style.background='#2c5aa0'; this.style.color='white'" onmouseout="this.style.background='#f8f9fa'; this.style.color='#2c5aa0'">
                    View All Products ‚Üí
                </a>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section style="padding: 4rem 0; background: #f8f9fa;">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 3rem; font-size: 2.5rem; color: #333;">Why Choose ElectraEdge?
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üöö</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Free Shipping</h3>
                    <p style="color: #666;">Free delivery on orders over $50. Fast and secure shipping worldwide.</p>
                </div>

                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Secure Payment</h3>
                    <p style="color: #666;">Your payment information is protected with bank-level security.</p>
                </div>

                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üõ°Ô∏è</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">2-Year Warranty</h3>
                    <p style="color: #666;">Comprehensive warranty coverage on all premium electronics.</p>
                </div>

                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚≠ê</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Premium Quality</h3>
                    <p style="color: #666;">Only the finest electronics from trusted global brands.</p>
                </div>

                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìû</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">24/7 Support</h3>
                    <p style="color: #666;">Round-the-clock customer support for all your needs.</p>
                </div>

                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üíé</div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Elite Rewards</h3>
                    <p style="color: #666;">Earn points with every purchase and unlock exclusive benefits.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Newsletter Section -->
    <section style="padding: 4rem 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="container" style="text-align: center;">
            <h2 style="margin-bottom: 1rem; font-size: 2.5rem;">Stay Connected</h2>
            <p style="margin-bottom: 2rem; font-size: 1.2rem; opacity: 0.9;">Get the latest updates on new products and
                exclusive offers</p>

            <form id="newsletterForm" style="max-width: 500px; margin: 0 auto; display: flex; gap: 1rem;">
                <input type="email" id="newsletterEmail" placeholder="Enter your email address"
                    style="flex: 1; padding: 1rem; border: none; border-radius: 8px; font-size: 1rem;">
                <button type="submit" class="btn btn-secondary"
                    style="background: white; color: #667eea; border: 2px solid white;">Subscribe</button>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <script>
        fetch("footer.html")
            .then(res => res.text())
            .then(data => {
                document.getElementById("footer-placeholder").innerHTML = data;
            });
    </script>

    <!-- Shopping Cart Modal -->
    <div id="cartModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div
            style="background: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>Shopping Cart</h3>
                <button onclick="toggleCart()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>

            <div id="cartItems">
                <p style="text-align: center; color: #666; padding: 2rem;">Your cart is empty</p>
            </div>

            <div id="cartTotal" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                    <span>Total: </span>
                    <span id="totalAmount">$0.00</span>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary w-100" onclick="toggleCart()">Continue Shopping</button>
                <a href="cart.html" class="btn btn-primary w-100" style="text-align: center; text-decoration: none;">Go to Cart</a>
            </div>
        </div>
    </div>

    <!-- Success Notification -->
    <div id="notification"
        style="display: none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <span id="notificationText">Item added to cart!</span>
    </div>

    <script>
        // Load featured products on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== HOME PAGE LOADED ===');
            
            // Load featured products first
            loadFeaturedProducts();
            
            // Set up session change listeners
            window.sessionManager.onSessionChange(handleSessionChange);
            
            // Initialize other features
            initializePageFeatures();
            
            // Hide 'Join ElectraEdge' button if user is logged in
            window.sessionManager.checkSession().then(() => {
                if (window.sessionManager.isLoggedIn()) {
                    const joinBtn = document.getElementById('join-electraedge-btn');
                    if (joinBtn) joinBtn.style.display = 'none';
                }
            });
        });

        // Load featured products from database
        async function loadFeaturedProducts() {
            console.log('üîÑ Loading featured products from database...');
            
            const loadingDiv = document.getElementById('featured-loading');
            const productsDiv = document.getElementById('featuredProducts');
            const errorDiv = document.getElementById('featured-error');
            
            // Show loading state
            loadingDiv.style.display = 'block';
            productsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('get_products.php');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const products = await response.json();
                console.log('üì¶ Products received:', products);
                
                if (!products || products.length === 0) {
                    throw new Error('No products available');
                }
                
                // Take only the first 3 products for featured section
                const featuredProducts = products.slice(0, 3);
                
                displayFeaturedProducts(featuredProducts);
                
            } catch (error) {
                console.error('‚ùå Error loading featured products:', error);
                showFeaturedError();
            }
        }

        // Display featured products
        function displayFeaturedProducts(products) {
            const loadingDiv = document.getElementById('featured-loading');
            const productsDiv = document.getElementById('featuredProducts');
            const errorDiv = document.getElementById('featured-error');
            
            let productsHTML = '';
            
            products.forEach(product => {
                // Handle image path
                let imageSrc = 'uploads/no-image.jpg';
                if (product.image_path) {
                    if (product.image_path.startsWith('http') || product.image_path.startsWith('/uploads/')) {
                        imageSrc = product.image_path;
                    } else {
                        imageSrc = '/uploads/products/' + product.image_path;
                    }
                }
                
                const price = parseFloat(product.price);
                const isInStock = parseInt(product.stock) > 0;
                
                productsHTML += `
                    <div class="product-card">
                        <div class="product-image">
                            <img src="${imageSrc}" alt="${product.name}" 
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='uploads/no-image.jpg'" />
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-rating">
                                <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                <span>(Featured)</span>
                            </div>
                            <div class="product-price">$${price.toFixed(2)}</div>
                            <button class="btn btn-primary w-100" 
                                    ${isInStock ? '' : 'disabled'} 
                                    onclick="addToCartFromFeatured(event, ${product.product_id})"
                                    style="${isInStock ? '' : 'opacity: 0.6; cursor: not-allowed;'}">
                                ${isInStock ? 'Add to Cart' : 'Out of Stock'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            productsDiv.innerHTML = productsHTML;
            
            // Hide loading, show products
            loadingDiv.style.display = 'none';
            productsDiv.style.display = 'grid';
            errorDiv.style.display = 'none';
            
            console.log('‚úÖ Featured products displayed successfully');
        }

        // Show error state
        function showFeaturedError() {
            const loadingDiv = document.getElementById('featured-loading');
            const productsDiv = document.getElementById('featuredProducts');
            const errorDiv = document.getElementById('featured-error');
            
            loadingDiv.style.display = 'none';
            productsDiv.style.display = 'none';
            errorDiv.style.display = 'block';
        }

        // Add to cart from featured products section
        async function addToCartFromFeatured(event, productId) {
            // Prevent card click event
            event.stopPropagation();
            
            console.log('=== ADD TO CART CLICKED (FEATURED PRODUCT) ===');
            console.log('Product ID:', productId);
            
            // Check if user is logged in using session manager
            const loginRequired = await window.sessionManager.requireLogin();
            if (!loginRequired) {
                return; // Will redirect to login
            }
            
            // User is authenticated, add to database
            await addItemToDatabase(productId);
        }

        // Add item to database (same as catalog)
        async function addItemToDatabase(productId) {
            console.log('‚úÖ Adding product to database:', productId);
            
            try {
                // Show loading state
                showNotification('Adding to cart...', 'info');
                
                const response = await fetch('php/add_to_cart.php', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        product_id: parseInt(productId), 
                        quantity: 1 
                    })
                });

                console.log('Add to cart response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Add to cart response:', data);
                
                if (data.success) {
                    console.log('‚úÖ Product successfully added to cart in database');
                    showNotification(`${data.product_name || 'Product'} added to cart!`, 'success');
                    
                    // Update cart count in header
                    updateCartCountInHeader();
                    
                } else {
                    console.error('‚ùå Add to cart failed:', data.message);
                    showNotification('Failed to add to cart: ' + (data.message || 'Unknown error'), 'error');
                }
                
            } catch (error) {
                console.error('üí• Add to cart error:', error);
                showNotification('Failed to add to cart. Please try again.', 'error');
            }
        }

        // Update cart count in header
        async function updateCartCountInHeader() {
            try {
                const response = await fetch('php/get_cart.php', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const cartCount = document.getElementById('cartCount');
                        if (cartCount) {
                            cartCount.textContent = data.cartCount || 0;
                        }
                        console.log('üîÑ Cart count updated:', data.cartCount);
                    }
                }
            } catch (error) {
                console.error('Failed to update cart count:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            // Remove existing notification first
            const existing = document.getElementById('home-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'home-notification';

            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 1rem 2rem;
                border-radius: 8px;
                z-index: 3000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                font-family: Arial, sans-serif;
                font-size: 14px;
                transition: opacity 0.3s ease;
            `;

            // Use textContent to avoid XSS
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
    </script>

    <script src="js/index.js"></script>
</body>
</html>